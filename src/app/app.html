<main class="container mx-auto p-4">
  <a href="#"
    class="block w-full  p-6 bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700">
    <h5 class="mb-2 text-3xl font-bold tracking-tight text-gray-900 dark:text-white">Comparador de pedidos y cat√°logos
      del Hospital Infanta Margarita</h5>
    <p class="font-normal text-gray-700 dark:text-gray-400">
      Esta aplicaci√≥n permite comparar las columnas del cat√°logo de un almac√©n con las columnas de pedidos realizados
      por los diferentes servicios del hospital.
    </p>
  </a>

  <section class="mt-10">
    <div class="grid grid-cols-2 gap-4">
      <div
        class="block w-full  p-6 bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700">
        <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Cargar archivo CAT√ÅLOGO</h5>
        <div class="mt-4">
          <input
            #catalogoInput
            class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"
            id="file_input_catalogo" type="file" accept=".xlsx, .xls"
            (change)="onCatalogFileSelected($event)" />
        </div>
      </div>
      <div
        class="block w-full  p-6 bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700">
        <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Cargar archivos L√çNEAS DE PEDIDO</h5>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
          Puedes seleccionar m√∫ltiples archivos usando la tecla Ctrl. Todos deben tener la misma estructura de columnas.
        </p>
        <div class="mt-4">
          <input
            #lineasInput
            class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"
            id="file_input_lineas" type="file" accept=".xlsx, .xls" multiple
            (change)="onLineasFilesSelected($event)" />
          
          @if (lineasFiles().length > 0) {
            <button 
              type="button"
              class="mt-3 px-4 py-2 bg-red-500 hover:bg-red-600 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm text-white focus:outline-none dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800"
              (click)="clearLineasFiles()">
              üóëÔ∏è Limpiar archivos
            </button>
          }
        </div>
      </div>
    </div>

    <!-- Estado de archivos seleccionados -->
    @if (catalogoFile() || lineasFiles().length > 0) {
      <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg dark:bg-blue-900/20 dark:border-blue-800">
        <h6 class="text-lg font-semibold text-blue-900 dark:text-blue-100 mb-2">Archivos seleccionados:</h6>
        
        @if (catalogoFile()) {
          <p class="text-sm text-blue-800 dark:text-blue-200">
            üìÇ <strong>Cat√°logo:</strong> {{ catalogoFile()!.name }}
            @if (catalogoData().length > 0) {
              <span class="text-green-600 dark:text-green-400"> ({{ catalogoData().length }} registros procesados)</span>
            }
          </p>
        }
        
        @if (lineasFiles().length > 0) {
          <div class="text-sm text-blue-800 dark:text-blue-200">
            üìã <strong>L√≠neas de pedido:</strong> {{ lineasFiles().length }} archivo(s) seleccionado(s)
            @if (lineasData().length > 0) {
              <span class="text-green-600 dark:text-green-400"> ({{ lineasData().length }} registros totales consolidados)</span>
            }
            @if (!lineasFilesValid()) {
              <span class="text-red-600 dark:text-red-400"> ‚ö†Ô∏è Algunos archivos tienen errores</span>
            }
          </div>
        }

        @if (isProcessing()) {
          <p class="text-sm text-yellow-600 dark:text-yellow-400 mt-2">
            ‚è≥ Procesando archivos...
          </p>
        }
      </div>
    }

    <!-- Estado detallado de archivos de l√≠neas de pedido -->
    @if (processedLineasFiles().length > 0) {
      <div class="mt-4 p-4 bg-white border border-gray-300 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-600">
        <h6 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Estado de archivos de l√≠neas de pedido:</h6>
        
        <div class="space-y-3">
          @for (fileInfo of processedLineasFiles(); track fileInfo.file.name) {
            <div class="flex items-center justify-between p-4 rounded-lg border shadow-sm" 
                 [class.bg-green-50]="fileInfo.processed && !fileInfo.error"
                 [class.border-green-300]="fileInfo.processed && !fileInfo.error"
                 [class.text-green-900]="fileInfo.processed && !fileInfo.error"
                 [class.bg-red-50]="fileInfo.processed && fileInfo.error"
                 [class.border-red-300]="fileInfo.processed && fileInfo.error"
                 [class.text-red-900]="fileInfo.processed && fileInfo.error"
                 [class.bg-yellow-50]="!fileInfo.processed"
                 [class.border-yellow-300]="!fileInfo.processed"
                 [class.text-yellow-900]="!fileInfo.processed">
              
              <div class="flex items-center space-x-3">
                @if (!fileInfo.processed) {
                  <span class="text-yellow-600 text-lg">‚è≥</span>
                } @else if (fileInfo.error) {
                  <span class="text-red-600 text-lg">‚ùå</span>
                } @else {
                  <span class="text-green-600 text-lg">‚úÖ</span>
                }
                
                <div>
                  <span class="text-sm font-semibold" 
                        [class.text-green-800]="fileInfo.processed && !fileInfo.error"
                        [class.text-red-800]="fileInfo.processed && fileInfo.error"
                        [class.text-yellow-800]="!fileInfo.processed">
                    {{ fileInfo.file.name }}
                  </span>
                  @if (fileInfo.processed && !fileInfo.error) {
                    <div class="text-xs text-green-600 mt-1">
                      üìä {{ fileInfo.data.length }} registros ‚Ä¢ {{ fileInfo.columns.length }} columnas
                    </div>
                  }
                  @if (fileInfo.error) {
                    <div class="text-xs text-red-700 mt-1 font-medium">{{ fileInfo.error }}</div>
                  }
                  @if (!fileInfo.processed) {
                    <div class="text-xs text-yellow-600 mt-1">Procesando archivo...</div>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- Mostrar columnas extra√≠das 
    @if (catalogoColumns().length > 0 || lineasColumns().length > 0) {
      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        
        @if (catalogoColumns().length > 0) {
          <div class="p-4 bg-green-50 border border-green-200 rounded-lg dark:bg-green-900/20 dark:border-green-800">
            <h6 class="text-lg font-semibold text-green-900 dark:text-green-100 mb-3">
              Columnas del Cat√°logo ({{ catalogoColumns().length }})
            </h6>
            <div class="max-h-60 overflow-y-auto">
              <ul class="space-y-1">
                @for (column of catalogoColumns(); track column) {
                  <li class="text-sm text-green-800 dark:text-green-200 bg-green-100 dark:bg-green-800/30 px-2 py-1 rounded">
                    {{ column }}
                  </li>
                }
              </ul>
            </div>
          </div>
        }

        @if (lineasColumns().length > 0) {
          <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg dark:bg-purple-900/20 dark:border-purple-800">
            <h6 class="text-lg font-semibold text-purple-900 dark:text-purple-100 mb-3">
              Columnas de L√≠neas de Pedido ({{ lineasColumns().length }})
            </h6>
            <div class="max-h-60 overflow-y-auto">
              <ul class="space-y-1">
                @for (column of lineasColumns(); track column) {
                  <li class="text-sm text-purple-800 dark:text-purple-200 bg-purple-100 dark:bg-purple-800/30 px-2 py-1 rounded">
                    {{ column }}
                  </li>
                }
              </ul>
            </div>
          </div>
        }
      </div>
    }-->

    <!-- Secci√≥n de comparaci√≥n -->
    @if (catalogoColumns().length > 0 && lineasColumns().length > 0) {
      <section class="mt-8">
        <div class="p-6 bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200 rounded-lg shadow-sm dark:from-indigo-900/20 dark:to-blue-900/20 dark:border-indigo-800">
          <h5 class="text-2xl font-bold tracking-tight text-indigo-900 dark:text-indigo-100 mb-4">
            üîç Comparador de Columnas
          </h5>
          <p class="text-indigo-700 dark:text-indigo-300 mb-6">
            Selecciona una columna de cada archivo para encontrar valores del cat√°logo que no est√°n presentes en las l√≠neas de pedido.
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Selector de columna del cat√°logo -->
            <div>
              <label for="catalogo-column-select" class="block text-sm font-medium text-indigo-900 dark:text-indigo-100 mb-2">
                Columna del Cat√°logo
              </label>
              <select 
                id="catalogo-column-select"
                class="w-full px-3 py-2 border border-indigo-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-800 dark:border-indigo-600 dark:text-white"
                [value]="selectedCatalogoColumn()"
                (change)="selectedCatalogoColumn.set($any($event.target).value)">
                <option value="">Selecciona una columna...</option>
                @for (column of catalogoColumns(); track column) {
                  <option [value]="column">{{ column }}</option>
                }
              </select>
            </div>

            <!-- Selector de columna de l√≠neas de pedido -->
            <div>
              <label for="lineas-column-select" class="block text-sm font-medium text-indigo-900 dark:text-indigo-100 mb-2">
                Columna de L√≠neas de Pedido
              </label>
              <select 
                id="lineas-column-select"
                class="w-full px-3 py-2 border border-indigo-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-800 dark:border-indigo-600 dark:text-white"
                [value]="selectedLineasColumn()"
                (change)="selectedLineasColumn.set($any($event.target).value)">
                <option value="">Selecciona una columna...</option>
                @for (column of lineasColumns(); track column) {
                  <option [value]="column">{{ column }}</option>
                }
              </select>
            </div>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="flex flex-wrap gap-3">
            <button 
              type="button"
              class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 font-medium rounded-lg text-sm text-white focus:outline-none dark:bg-indigo-600 dark:hover:bg-indigo-700 dark:focus:ring-indigo-800 disabled:opacity-50 disabled:cursor-not-allowed"
              [disabled]="!selectedCatalogoColumn() || !selectedLineasColumn() || isComparing()"
              (click)="compareColumns()">
              @if (isComparing()) {
                ‚è≥ Comparando...
              } @else {
                üîç Comparar Columnas
              }
            </button>
            
            @if (comparisonResults().length > 0) {
              <button 
                type="button"
                class="px-6 py-2 bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm text-white focus:outline-none dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800"
                (click)="exportResults()">
                üì• Exportar Resultados
              </button>
              
              <button 
                type="button"
                class="px-6 py-2 bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm text-white focus:outline-none dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                (click)="exportCleanCatalog()"
                title="Descarga un archivo Excel del cat√°logo sin las filas que contienen valores no encontrados">
                üßπ Descargar Cat√°logo Limpio
              </button>
            }
            
            @if (selectedCatalogoColumn() || selectedLineasColumn() || comparisonResults().length > 0) {
              <button 
                type="button"
                class="px-6 py-2 bg-gray-500 hover:bg-gray-600 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm text-white focus:outline-none dark:bg-gray-600 dark:hover:bg-gray-700 dark:focus:ring-gray-800"
                (click)="clearComparison()">
                üßπ Limpiar
              </button>
            }
          </div>
        </div>
      </section>
    }

    <!-- Resultados de la comparaci√≥n -->
    @if (comparisonResults().length > 0) {
      <section class="mt-6">
        <div class="p-6 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-800">
          <h6 class="text-xl font-semibold text-red-900 dark:text-red-100 mb-4">
            ‚ö†Ô∏è Valores del Cat√°logo No Encontrados en Pedidos
          </h6>
          <p class="text-red-700 dark:text-red-300 mb-4">
            Se encontraron <strong>{{ comparisonResults().length }}</strong> valores en la columna 
            "<strong>{{ selectedCatalogoColumn() }}</strong>" del cat√°logo que no est√°n presentes 
            en la columna "<strong>{{ selectedLineasColumn() }}</strong>" de las l√≠neas de pedido:
          </p>
          
          <div class="max-h-80 overflow-y-auto bg-white dark:bg-gray-800 border border-red-300 dark:border-red-700 rounded p-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
              @for (value of comparisonResults(); track value) {
                <div class="bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 px-3 py-2 rounded text-sm border border-red-200 dark:border-red-700">
                  {{ value }}
                </div>
              }
            </div>
          </div>
        </div>
      </section>
    }

    @if (comparisonResults().length === 0 && selectedCatalogoColumn() && selectedLineasColumn() && !isComparing()) {
      <section class="mt-6">
        <div class="p-6 bg-green-50 border border-green-200 rounded-lg dark:bg-green-900/20 dark:border-green-800">
          <h6 class="text-xl font-semibold text-green-900 dark:text-green-100 mb-2">
            ‚úÖ Comparaci√≥n Completada
          </h6>
          <p class="text-green-700 dark:text-green-300">
            ¬°Excelente! Todos los valores de la columna "<strong>{{ selectedCatalogoColumn() }}</strong>" 
            del cat√°logo est√°n presentes en la columna "<strong>{{ selectedLineasColumn() }}</strong>" 
            de las l√≠neas de pedido.
          </p>
        </div>
      </section>
    }
  </section>
</main>

<!-- Contenedor de Toasts -->
<div id="toast-container" class="fixed top-5 right-5 z-50 space-y-4 max-w-xs">
  <!-- Los toasts se insertar√°n aqu√≠ din√°micamente -->
</div>